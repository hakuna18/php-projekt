<?php
/**
 * ReservationRepository.
 */
namespace AppBundle\Repository;

use Pagerfanta\Pagerfanta;
use Pagerfanta\Adapter\ArrayAdapter;
use AppBundle\Entity\Reservation;

/**
 * ReservationRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ReservationRepository extends \Doctrine\ORM\EntityRepository
{
    /**
     * Query by user's surname/email or book's ISBN
     *
     * @param string $pattern
     *
     * @param int    $page
     *
     * @return Pagerfanta\Pagerfanta
     */
    public function query($pattern, $page = 1)
    {
        $pattern = '/'.strtoupper(trim($pattern)).'/';
        $result = array();
        // If regex valid
        if (@preg_match($pattern, null) !== false) {
            $reservations = $this->findAll();
            foreach ($reservations as $reservation) {
                if (preg_match($pattern, strtoupper($reservation->getUser()->getSurname()))
                || preg_match($pattern, strtoupper($reservation->getUser()->getEmail()))
                || preg_match($pattern, strtoupper($reservation->getBook()->getISBN()))
                ) {
                    array_push($result, $reservation);
                }
            }
        }

        $paginator = new Pagerfanta(new ArrayAdapter($result));
        $paginator->setMaxPerPage(Reservation::NUM_ITEMS);
        $paginator->setCurrentPage($page);

        return $paginator;
    }
}

